name: accelerator-wg-workflow-validation

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/accelerator-wg-workflow-validation.yml'
      - 'scripts/link_accelerator_submodule.sh'
      - 'docs/accelerator_wg_workflow_validation.md'
  pull_request:
    paths:
      - '.github/workflows/accelerator-wg-workflow-validation.yml'
      - 'scripts/link_accelerator_submodule.sh'
      - 'docs/accelerator_wg_workflow_validation.md'

permissions:
  contents: read

jobs:
  discover-accelerator-wg-workflows:
    runs-on: ubuntu-latest
    outputs:
      workflow_matrix: ${{ steps.enumerate.outputs.workflow_matrix }}
      workflow_count: ${{ steps.enumerate.outputs.workflow_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Link accelerator-integration-wg submodule
        run: ./scripts/link_accelerator_submodule.sh

      - name: Enumerate upstream workflow files
        id: enumerate
        shell: bash
        run: |
          set -euo pipefail
          WORKFLOW_DIR="third_party/accelerator-integration-wg/.github/workflows"

          if [[ ! -d "$WORKFLOW_DIR" ]]; then
            echo "Workflow directory does not exist: $WORKFLOW_DIR" >&2
            exit 1
          fi

          find "$WORKFLOW_DIR" -type f \( -name '*.yml' -o -name '*.yaml' \) | sort | tee workflow-files.txt

          if [[ ! -s workflow-files.txt ]]; then
            echo "No workflow files found under $WORKFLOW_DIR" >&2
            exit 1
          fi

          matrix_json=$(ruby -ryaml -rjson -e '
            files = STDIN.read.split("\n").map(&:strip).reject(&:empty?)
            rows = files.map do |path|
              doc = YAML.load_file(path)
              on_cfg = doc.is_a?(Hash) ? (doc["on"] || doc[:on] || doc[true]) : nil
              triggers = case on_cfg
                         when String then [on_cfg]
                         when Array then on_cfg
                         when Hash then on_cfg.keys
                         else []
                         end.map(&:to_s)

              {
                "path" => path,
                "workflow_file" => File.basename(path),
                "dispatchable" => triggers.include?("workflow_dispatch")
              }
            end
            puts(JSON.generate(rows))
          ' < workflow-files.txt)

          echo "workflow_matrix=$matrix_json" >> "$GITHUB_OUTPUT"
          echo "workflow_count=$(wc -l < workflow-files.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Upload workflow inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: accelerator-wg-workflow-files
          path: workflow-files.txt

  execute-accelerator-wg-workflows:
    runs-on: ubuntu-latest
    needs: discover-accelerator-wg-workflows
    strategy:
      fail-fast: false
      matrix:
        workflow: ${{ fromJson(needs.discover-accelerator-wg-workflows.outputs.workflow_matrix) }}
    env:
      TARGET_REPO: pytorch-fdn/accelerator-integration-wg
      TARGET_REF: main
      GH_TOKEN: ${{ secrets.ACCELERATOR_WG_TOKEN }}
    steps:
      - name: Ensure dispatch token exists
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "Missing required secret ACCELERATOR_WG_TOKEN for dispatching upstream workflows" >&2
            exit 1
          fi

      - name: Ensure workflow supports workflow_dispatch
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ matrix.workflow.dispatchable }}" != "true" ]]; then
            echo "Workflow does not support workflow_dispatch: ${{ matrix.workflow.path }}" >&2
            echo "To execute all workflows from this orchestrator, upstream workflow must add 'on: workflow_dispatch'." >&2
            exit 1
          fi

      - name: Dispatch upstream workflow and wait for completion
        shell: bash
        run: |
          set -euo pipefail
          wf_file='${{ matrix.workflow.workflow_file }}'
          echo "Dispatching ${TARGET_REPO}/${wf_file} on ref ${TARGET_REF}"

          started_at=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          curl -sS -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TARGET_REPO}/actions/workflows/${wf_file}/dispatches" \
            -d "$(jq -nc --arg ref "${TARGET_REF}" '{ref:$ref}')"

          run_id=""
          for _ in $(seq 1 60); do
            sleep 10
            runs_json=$(curl -sS \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${TARGET_REPO}/actions/workflows/${wf_file}/runs?event=workflow_dispatch&branch=${TARGET_REF}&per_page=20")

            run_id=$(echo "$runs_json" | jq -r --arg started_at "$started_at" '
              .workflow_runs
              | map(select(.created_at >= $started_at))
              | sort_by(.created_at)
              | reverse
              | .[0].id // empty
            ')

            if [[ -n "$run_id" ]]; then
              status=$(echo "$runs_json" | jq -r --argjson id "$run_id" '.workflow_runs[] | select(.id == $id) | .status')
              conclusion=$(echo "$runs_json" | jq -r --argjson id "$run_id" '.workflow_runs[] | select(.id == $id) | (.conclusion // "")')
              html_url=$(echo "$runs_json" | jq -r --argjson id "$run_id" '.workflow_runs[] | select(.id == $id) | .html_url')

              echo "Run ${run_id} status=${status} conclusion=${conclusion} url=${html_url}"

              if [[ "$status" == "completed" ]]; then
                if [[ "$conclusion" == "success" ]]; then
                  exit 0
                fi
                echo "Upstream workflow failed: ${html_url}" >&2
                exit 1
              fi
            fi
          done

          echo "Timed out waiting for workflow run for ${wf_file}" >&2
          exit 1
