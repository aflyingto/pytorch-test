name: accelerator-wg-workflow-validation

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/accelerator-wg-workflow-validation.yml'
      - 'scripts/link_accelerator_submodule.sh'
      - 'docs/accelerator_wg_workflow_validation.md'
  pull_request:
    paths:
      - '.github/workflows/accelerator-wg-workflow-validation.yml'
      - 'scripts/link_accelerator_submodule.sh'
      - 'docs/accelerator_wg_workflow_validation.md'

permissions:
  contents: read

jobs:
  discover-accelerator-wg-workflows:
    runs-on: ubuntu-latest
    outputs:
      workflow_matrix: ${{ steps.enumerate.outputs.workflow_matrix }}
      workflow_count: ${{ steps.enumerate.outputs.workflow_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Link accelerator-integration-wg submodule
        run: ./scripts/link_accelerator_submodule.sh

      - name: Enumerate upstream workflow files
        id: enumerate
        shell: bash
        run: |
          set -euo pipefail
          WORKFLOW_DIR="third_party/accelerator-integration-wg/.github/workflows"

          if [[ ! -d "$WORKFLOW_DIR" ]]; then
            echo "Workflow directory does not exist: $WORKFLOW_DIR" >&2
            exit 1
          fi

          find "$WORKFLOW_DIR" -type f \( -name '*.yml' -o -name '*.yaml' \) | sort | tee workflow-files.txt

          if [[ ! -s workflow-files.txt ]]; then
            echo "No workflow files found under $WORKFLOW_DIR" >&2
            exit 1
          fi

          matrix_json=$(jq -R -s -c 'split("\n") | map(select(length > 0))' workflow-files.txt)
          echo "workflow_matrix=$matrix_json" >> "$GITHUB_OUTPUT"
          echo "workflow_count=$(wc -l < workflow-files.txt | tr -d ' ')" >> "$GITHUB_OUTPUT"

      - name: Upload workflow inventory artifact
        uses: actions/upload-artifact@v4
        with:
          name: accelerator-wg-workflow-files
          path: workflow-files.txt

  run-accelerator-wg-workflows:
    runs-on: ubuntu-latest
    needs: discover-accelerator-wg-workflows
    strategy:
      fail-fast: false
      matrix:
        workflow: ${{ fromJson(needs.discover-accelerator-wg-workflows.outputs.workflow_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Link accelerator-integration-wg submodule
        run: ./scripts/link_accelerator_submodule.sh

      - name: Install act
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://raw.githubusercontent.com/nektos/act/master/install.sh | sudo bash -s -- -b /usr/local/bin
          act --version

      - name: Execute upstream workflow via act
        shell: bash
        run: |
          set -euo pipefail
          wf="${{ matrix.workflow }}"
          echo "Running workflow: $wf"

          trigger_event=$(ruby -ryaml -e '
            on_cfg = YAML.load_file(ARGV[0])["on"]
            keys = case on_cfg
                   when String then [on_cfg]
                   when Array then on_cfg
                   when Hash then on_cfg.keys
                   else []
                   end.map(&:to_s)
            preferred = %w[workflow_dispatch push pull_request schedule]
            event = preferred.find { |e| keys.include?(e) }
            puts(event.to_s)
          ' "$wf")

          if [[ -z "$trigger_event" ]]; then
            echo "No runnable trigger found in $wf (expected one of workflow_dispatch/push/pull_request/schedule)" >&2
            exit 1
          fi

          echo "Selected trigger event: $trigger_event"
          act "$trigger_event" --workflows "$wf" --container-architecture linux/amd64 --pull=false
